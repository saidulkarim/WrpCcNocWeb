@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor

@{
    var language = HttpContextAccessor.HttpContext.Request.Cookies["FormLanguage"].ToString();
}

<div id="proj-loc-form">
    <style type="text/css">
        .btn-upload {
            display: inline-block;
            padding: 5px 5px;
            margin-bottom: 0;
            font-size: 14px;
            font-weight: normal;
            line-height: 1.42857143;
            text-align: center;
            white-space: nowrap;
            vertical-align: middle;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            background-image: none;
            border: 1px solid transparent;
            border-radius: 4px;
        }

        .btn-upload-success {
            border: 1px solid #c5dbec;
            background: #D0E5F5;
            color: #2e6e9e;
        }

        .fileinput-button {
            position: relative;
            overflow: hidden;
        }

            .fileinput-button input {
                position: absolute;
                top: 0;
                right: 0;
                margin: 0;
                opacity: 0;
                -ms-filter: 'alpha(opacity=0)';
                font-size: 200px;
                direction: ltr;
                cursor: pointer;
            }

        .thumb {
            height: 65px;
            width: 100px;
            border: 1px solid #000;
            padding: 1px;
            border-radius: 2px;
        }

        ul.thumb-Images li {
            width: 120px;
            float: left;
            display: inline-block;
            vertical-align: top;
            height: 120px;
        }

        .img-wrap {
            position: relative;
            display: inline-block;
            font-size: 0;
        }

            .img-wrap .close {
                position: absolute;
                top: 5px;
                right: 5px;
                z-index: 100;
                background-color: #D0E5F5;
                padding: 5px 5px 5px;
                color: #000;
                font-weight: bolder;
                cursor: pointer;
                opacity: .5;
                font-size: 23px;
                line-height: 10px;
                border-radius: 50%;
            }

            .img-wrap:hover .close {
                opacity: 1;
                background-color: #ff0000;
            }

        .FileNameCaptionStyle {
            font-size: 12px;
        }

        .img-cell-thumb {
            height: 35px;
            margin-right: 3px;
            border: 1px solid #C5DBEC;
            border-radius: 3px;
            padding: 1px;
        }

        .location-controls {
            font-size: 80% !important;
        }
    </style>

    <div id="divProjectLocation">
        <div id="ProjectLocation" class="row" style="margin-left: -7px;">
            <div class="table-responsive">
                <table class="table" style="font-size: 80%;">
                    <thead>
                        <tr>
                            <th class="text-center" for="DistrictGeoCode">
                                @{if (language == "1")
                                    { <span>জেলা</span> }
                                    else
                                    { <span>District</span> }
                                }
                            </th>
                            <th class="text-center" for="UpazilaGeoCode">
                                @{if (language == "1")
                                    { <span>উপজেলা</span> }
                                    else
                                    { <span>Upazila</span> }
                                }
                            </th>
                            <th class="text-center" for="UnionGeoCode">
                                @{if (language == "1")
                                    { <span>ইউনিয়ন</span> }
                                    else
                                    { <span>Union</span> }
                                }
                            </th>
                            <th class="text-center" for="Latitude">
                                @{if (language == "1")
                                    { <span>অক্ষাংশ</span> }
                                    else
                                    { <span>Latitude</span> }
                                }
                            </th>
                            <th class="text-center" for="Longitude">
                                @{if (language == "1")
                                    { <span>দ্রাঘিমাংশ</span> }
                                    else
                                    { <span>Longitude</span> }
                                }
                            </th>
                            <th class="text-center" for="ImageFileName" data-toggle="tooltip" data-placement="bottom" title=""
                                data-original-title="Allowed only files with extension jpg, png, gif, bmp, pdf. Maximum number of allowed files 10 with 800 KB for each. You can select files from different folders.">
                                @{if (language == "1")
                                    { <span>স্থানের ছবি</span>}
                                    else
                                    { <span>Location Photo</span>}
                                }
                            </th>
                            <th class="text-center" for="MapFileName" data-toggle="tooltip" data-placement="bottom" title=""
                                data-original-title="Allowed only file with extension (kml) with maximum 1 MB.">
                                @{if (language == "1")
                                    { <span>মানচিত্র</span>}
                                    else
                                    { <span>Map</span>}
                                }
                            </th>
                            <th class="text-center" style="width: 150px;"></th>
                        </tr>
                        <tr>
                            <th class="text-center">
                                <input id="LocationId" type="hidden" />

                                <select id="DistrictGeoCode" name="DistrictGeoCode" class="form-control" required="" style="width: 110px;">
                                    <option value="">
                                        @if (language == "1")
                                        {<span>বাছাই করুন...</span>}
                                        else
                                        {<span>Choose...</span>}
                                    </option>

                                    @{
                                        List<LookUpAdminBndDistrict> _districts = ViewBag.LookUpAdminBndDistrict;

                                        if (_districts.Count > 0)
                                        {
                                            foreach (LookUpAdminBndDistrict dist in _districts)
                                            {
                                                if (language == "1")
                                                {
                                                    <option value="@dist.DistrictGeoCode">@dist.DistrictNameBn</option>
                                                }
                                                else
                                                {
                                                    <option value="@dist.DistrictGeoCode">@dist.DistrictName</option>
                                                }
                                            }
                                        }
                                    }
                                </select>
                            </th>
                            <th class="text-center">
                                <select id="UpazilaGeoCode" name="UpazilaGeoCode" class="form-control" style="width: 110px;">
                                    <option value="">
                                        @{if (language == "1")
                                            { <span>বাছাই করুন...</span>}
                                            else
                                            {<span>Choose...</span>}
                                        }
                                    </option>
                                </select>
                            </th>
                            <th class="text-center">
                                <select id="UnionGeoCode" name="UnionGeoCode" class="form-control" style="width: 110px;">
                                    <option value="">
                                        @{if (language == "1")
                                            { <span>বাছাই করুন...</span>}
                                            else
                                            {<span>Choose...</span>}
                                        }
                                    </option>
                                </select>
                            </th>
                            <th class="text-center">
                                <input type="number" min="0" id="Latitude" name="Latitude" class="form-control text-right" style="width: 110px;font-size: 90%;" />
                            </th>
                            <th class="text-center">
                                <input type="number" min="0" id="Longitude" name="Longitude" class="form-control text-right" style="width: 110px;font-size: 90%;" />
                            </th>
                            <th class="text-center" style="vertical-align: central;">
                                <span class="btn-upload btn-upload-success fileinput-button">
                                    <span>
                                        @if (language == "1")
                                        {<span>সংযুক্তি</span> }
                                        else
                                        { <span>Attachments</span>}
                                    </span>

                                    <input type="file" name="files[]" id="files" multiple accept="image/jpeg, image/png, image/gif, image/bmp, application/pdf" />
                                </span>
                            </th>
                            <th class="text-center" style="vertical-align: central;">
                                <span class="btn-upload btn-upload-success fileinput-button">
                                    <span>
                                        @if (language == "1")
                                        {<span>মানচিত্র</span> }
                                        else
                                        { <span>Map</span>}
                                    </span>
                                    <input type="file" name="MapFile" id="MapFile" accept="application/vnd.google-earth.kml+xml"
                                           onchange="return ValidateFileUpload()" />
                                </span>

                                <input type="hidden" id="SelectedMapFile" name="SelectedMapFile" />
                            </th>
                            <th class="text-center" style="white-space: nowrap;">
                                <button id="btnSaveProjLocation" type="button" class="btn btn-success waves-effect waves-light" value="Save">
                                    <i class="mdi mdi-content-save"></i>
                                </button>

                                <button id="btnClearProjLocation" type="button" class="btn btn-warning waves-effect waves-light" value="Clear">
                                    <i class="mdi mdi-refresh"></i>
                                </button>
                            </th>
                        </tr>
                        <tr>
                            <th colspan="8" class="text-center">
                                <output id="Filelist"></output>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="tbodyProjectLocation"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    //I added event handler for the file upload control to access the files properties.
    document.addEventListener("DOMContentLoaded", init, false);

    //To save an array of attachments
    var AttachmentArray = [];

    //counter for attachment array
    var arrCounter = 0;

    //to make sure the error message for number of files will be shown only one time.
    var filesCounterAlertStatus = false;

    jQuery(document).ready(function () {
        jQuery("#DistrictGeoCode").change(function () {
            var code = jQuery(this).val();
            var type = 'upz';

            if (code != '') {
                jQuery("#UpazilaGeoCode, #UnionGeoCode").html('<option value="">Choose...</option>');
                GetAdminData(code, type);
            }
        });

        jQuery("#UpazilaGeoCode").change(function () {
            var code = jQuery(this).val();
            var type = 'uni';

            if (code != '') {
                jQuery("#UnionGeoCode").html('<option value="">Choose...</option>');
                GetAdminData(code, type);
            }
        });

        jQuery("#btnSaveProjLocation").click(function () {
            var LocationId = jQuery("#LocationId").val();
            LocationId = (LocationId == '') ? 0 : LocationId;
            var DistrictGeoCode = jQuery("#DistrictGeoCode option:selected").val();
            var DistrictName = jQuery("#DistrictGeoCode option:selected").text();
            var UpazilaGeoCode = jQuery("#UpazilaGeoCode option:selected").val();
            var UpazilaName = jQuery("#UpazilaGeoCode option:selected").text();
            var UnionGeoCode = jQuery("#UnionGeoCode option:selected").val();
            var UnionName = jQuery("#UnionGeoCode option:selected").text();
            var Latitude = jQuery("#Latitude").val();
            var Longitude = jQuery("#Longitude").val();
            var SelectedMapFileTitle = jQuery("#SelectedMapFile").attr('title');
            var SelectedMapFile = jQuery("#SelectedMapFile").val();
            var row = '';

            //console.log('Total Attachments: ' + AttachmentArray.length);

            if (DistrictGeoCode != '' && DistrictGeoCode != undefined) {
                //var lfuData = document.getElementById('ImageFileName');
                //var FileUploadPath = lfuData.value;

                if (AttachmentArray.length > 0) {
                    var imgs = '';
                    jQuery.each(AttachmentArray, function (i, item) {
                        console.log(item.Content);
                        var img = new Image();
                        img.src = item.FullContent;
                        img.className = "img-cell-thumb";
                        imgs += img.outerHTML;
                    });

                    row = '<tr><td>' + DistrictName + ' <input id="hdDistrictGeoCode" type="hidden" value="' + DistrictGeoCode + '" /></td><td>' + UpazilaName + ' <input id="hdUpazilaGeoCode" type="hidden" value="' + UpazilaGeoCode + '" /></td><td>' + UnionName + ' <input id="hdUnionGeoCode" type="hidden" value="' + UnionGeoCode + '" /></td><td>' + Latitude + '</td><td>' + Longitude + '</td><td>' + imgs + '<input id="hdProjectLocationFile" type="hidden" value="' + JSON.stringify(AttachmentArray) + '" /></td><td>' + SelectedMapFileTitle + '<input id="hdSelectedMapFile" type="hidden" value="' + SelectedMapFile + '" /></td><td class="text-center"><button onclick="javascript:DeleteNewLocation(this);" type="button" class="btn btn-danger waves-effect waves-light"><i class="mdi mdi-delete"></i></button> <input id="hdLocationId" type="hidden" /></td></tr>';
                    jQuery("#tbodyProjectLocation").append(row);
                } else {
                    console.log('no image');
                    row = '<tr><td>' + DistrictName + ' <input id="hdDistrictGeoCode" type="hidden" value="' + DistrictGeoCode + '" /></td><td>' + UpazilaName + ' <input id="hdUpazilaGeoCode" type="hidden" value="' + UpazilaGeoCode + '" /></td><td>' + UnionName + ' <input id="hdUnionGeoCode" type="hidden" value="' + UnionGeoCode + '" /></td><td>' + Latitude + '</td><td>' + Longitude + '</td><td><input id="hdProjectLocationFile" type="hidden" value="" /></td><td>' + SelectedMapFileTitle + '<input id="hdSelectedMapFile" type="hidden" value="' + SelectedMapFile + '" /></td><td class="text-center"><button onclick="javascript:DeleteNewLocation(this);" type="button" class="btn btn-danger waves-effect waves-light"><i class="mdi mdi-delete"></i></button> <input id="hdLocationId" type="hidden" /></td></tr>';
                    jQuery("#tbodyProjectLocation").append(row);
                }

                //try {
                //    if (lfuData.files && lfuData.files[0]) {
                //        var FileName = lfuData.files[0].name;
                //        var Extension = FileName.replace(/^.*\./, '');

                //        if (Extension == "gif" || Extension == "png" || Extension == "bmp" || Extension == "jpeg" || Extension == "jpg") {
                //            var reader = new FileReader();
                //            reader.readAsDataURL(lfuData.files[0]);
                //            reader.onload = function (e) {
                //                var img = new Image();
                //                img.src = e.target.result;
                //                img.height = "50";

                //                row = '<tr><td>' + DistrictName + ' <input id="hdDistrictGeoCode" type="hidden" value="' + DistrictGeoCode + '" /></td><td>' + UpazilaName + ' <input id="hdUpazilaGeoCode" type="hidden" value="' + UpazilaGeoCode + '" /></td><td>' + UnionName + ' <input id="hdUnionGeoCode" type="hidden" value="' + UnionGeoCode + '" /></td><td>' + Latitude + '</td><td>' + Longitude + '</td><td>' + img.outerHTML + ' <input id="hdProjectLocationFile" type="hidden" value="' + e.target.result + '" /></td><td class="text-center"><button onclick="javascript:DeleteNewLocation(this);" type="button" class="btn btn-danger waves-effect waves-light"><i class="mdi mdi-delete"></i></button> <input id="hdLocationId" type="hidden" /></td></tr>';
                //                jQuery("#tbodyProjectLocation").append(row);
                //            }
                //        }
                //    } else {
                //        console.log('no image');
                //        row = '<tr><td>' + DistrictName + ' <input id="hdDistrictGeoCode" type="hidden" value="' + DistrictGeoCode + '" /></td><td>' + UpazilaName + ' <input id="hdUpazilaGeoCode" type="hidden" value="' + UpazilaGeoCode + '" /></td><td>' + UnionName + ' <input id="hdUnionGeoCode" type="hidden" value="' + UnionGeoCode + '" /></td><td>' + Latitude + '</td><td>' + Longitude + '</td><td><input id="hdProjectLocationFile" type="hidden" value="" /></td><td class="text-center"><button onclick="javascript:DeleteNewLocation(this);" type="button" class="btn btn-danger waves-effect waves-light"><i class="mdi mdi-delete"></i></button> <input id="hdLocationId" type="hidden" /></td></tr>';
                //        jQuery("#tbodyProjectLocation").append(row);
                //    }
                //} catch (ex) {
                //    console.log(ex.message);
                //}

                row = '';
                ClearProjLocation();
                Notification('success', 'Success', 'New location data added.');

                //#region old code for location save
                //var ProjectId = GetHiddenValue('ProjectId');
                //var plds = {
                //    "LocationId": LocationId,
                //    "ProjectId": ProjectId,
                //    "DistrictGeoCode": DistrictGeoCode,
                //    "UpazilaGeoCode": UpazilaGeoCode,
                //    "UnionGeoCode": UnionGeoCode,
                //    "Latitude": Latitude,
                //    "Longitude": Longitude
                //};
                //var url = 'Url.Action("plds", "form")';
                //jQuery.ajax({
                //    type: "POST",
                //    url: url,
                //    data: { _plds: plds },
                //    dataType: "json",
                //    success: function (data, status, jqXHR) {
                //        if (data.status == 'success') {
                //            var id = data.id;
                //            SaveProjLocFile(id, ProjectId);
                //            Notification('success', 'Success', data.message);
                //            GetProjLocationsData();
                //            ClearProjLocation();
                //        } else {
                //            Notification('error', 'Saving Error', data.message);
                //        }
                //    }, error: function (jqXHR, exception) {
                //        var errorMsg = AjaxErrorHandle(jqXHR, exception);
                //        Notification('error', 'Error Occured', errorMsg);
                //    }
                //});
                //#endregion
            } else {
                Notification('warning', 'Required Field', 'Please select your project district!');
                jQuery("#DistrictGeoCode").focus();
            }
        });

        jQuery("#btnClearProjLocation").click(function () {
            ClearProjLocation();
        });
    });

    @*function SaveProjLocFile(locationid, projectid) {
        var locfile = jQuery('#ImageFileName').prop('files')[0];

        var formData = new FormData();
        formData.append("locationid", locationid);
        formData.append("projectid", projectid);
        formData.append("file", locfile);

        var url = '@Url.Action("uplf", "form")';
        $.ajax({
            url: url,
            data: formData,
            processData: false,
            contentType: false,
            type: "POST",
            success: function (data) {
                if (data.message != '')
                    Swal.fire(data.title, data.message, data.status);
            }, error: function (jqXHR, exception) {
                var errorMsg = AjaxErrorHandle(jqXHR, exception);
                Swal.fire('Error Occured', errorMsg, 'error');
            }
        });
    }*@

    function ClearProjLocation() {
        jQuery("#LocationId").val('');
        jQuery("#DistrictGeoCode").val('');
        jQuery("#UpazilaGeoCode").html('<option val=""></option>');
        jQuery("#UnionGeoCode").html('<option val=""></option>');
        jQuery("#Latitude, #Longitude").val('');
        jQuery('#ImageFileName').val('');
        jQuery('#SelectedMapFile, #MapFile').val('');

        AttachmentArray = [];
        arrCounter = 0;
        jQuery('#Filelist').html('');

        console.log('Total Attachments: ' + AttachmentArray.length);
    }

    function GetProjLocationsData() {
            var lang = '@language';
            var ProjectId = GetHiddenValue('ProjectId');
            var url = '@Url.Action("get_pld", "form")';

            jQuery.ajax({
                type: "GET",
                url: url,
                data: { project_id: ProjectId },
                dataType: "json",
                success: function (data, status, jqXHR) {
                    console.log('Project Location Data Loaded...');
                    console.log(data);

                    if (data.length > 0) {
                        var rows = '';

                        var count = 0;

                        if (lang == '1') {
                            jQuery.each(data, function (i, item) {
                                var imgs = '';
                                if (item.imageFileName.length > 0) {
                                    for (var i = 0; i < item.imageFileName.length; i++) {
                                        var fileName = item.imageFileName[i] != '' ? '../images/ProjectLocationPhotos/' + item.imageFileName[i] : '../images/no_image.png';
                                        imgs += '<a href="' + fileName + '" target="_blank"><img src="' + fileName +'" class="img-cell-thumb" /></a>';
                                    }
                                }

                                var latitude = item.latitude == null ? '' : item.latitude;
                                var longitude = item.longitude == null ? '' : item.longitude;
                                var map_file = item.mapFileName != '' ? '../docs/map_kml/' + item.mapFileName : '#';
                                var map_file_name = item.mapFileName != '' ? item.mapFileName : 'No map attached';
                                //rows += '<tr><td scope="row" class="bold">' + count + '</td><td>' + item.districtNameBn + '</td><td>' + item.upazilaNameBn + '</td><td>' + item.unionNameBn + '</td><td>' + item.latitude + '</td><td>' + item.longitude + '</td><td><a href="' + fileName + '" target="_blank"><img src="' + fileName + '" height="50px" /></a></td><td class="text-center"><button onclick="javascript:EditLoc(' + item.locationId + ', ' + item.projectId + ');" type="button" class="btn btn-success waves-effect waves-light"><i class="mdi mdi-lead-pencil"></i></button> <button onclick="javascript:Delete(' + item.locationId + ', ' + item.projectId + ', \'CcModPrjLocationDetail\'); GetProjLocationsData();" type="button" class="btn btn-danger waves-effect waves-light"><i class="mdi mdi-delete"></i></button> <input id="hdLocationId" value="' + locationId + '" /></td></tr>';
                                rows += '<tr><td>' + item.districtNameBn + ' <input id="hdDistrictGeoCode" type="hidden" value="' + item.districtGeoCode + '" /></td><td>' + item.upazilaNameBn + ' <input id="hdUpazilaGeoCode" type="hidden" value="' + item.upazilaGeoCode + '" /></td><td>' + item.unionNameBn + ' <input id="hdUnionGeoCode" type="hidden" value="' + item.unionGeoCode + '" /></td><td>' + latitude + '</td><td>' + longitude + '</td><td>' + imgs + '</td><td><a href="' + map_file + '" target="_blank">' + map_file_name + '</a></td><td class="text-center"><button onclick="javascript:DeleteLocation(this, ' + item.locationId + ', ' + item.projectId + ', \'CcModPrjLocationDetail\');" type="button" class="btn btn-danger waves-effect waves-light"><i class="mdi mdi-delete"></i></button> <input id="hdLocationId" type="hidden" value="' + item.locationId + '" /></td></tr>';
                            });
                        } else {
                            jQuery.each(data, function (i, item) {
                                var imgs = '';
                                if (item.imageFileName.length > 0) {
                                    for (var i = 0; i < item.imageFileName.length; i++) {
                                        var fileName = item.imageFileName[i] != '' ? '../images/ProjectLocationPhotos/' + item.imageFileName[i] : '../images/no_image.png';
                                        imgs += '<a href="' + fileName + '" target="_blank"><img src="' + fileName + '" class="img-cell-thumb" /></a>';
                                    }
                                }

                                var latitude = item.latitude == null ? '' : item.latitude;
                                var longitude = item.longitude == null ? '' : item.longitude;
                                var map_file = item.mapFileName != '' ? '../docs/map_kml/' + item.mapFileName : '#';
                                var map_file_name = item.mapFileName != '' ? item.mapFileName : 'No map attached';
                                //below line comment out on 19 Aug, 2020. project location tab to general tab
                                //rows += '<tr><td scope="row" class="bold">' + count + '</td><td>' + item.districtName + '</td><td>' + item.upazilaName + '</td><td>' + item.unionName + '</td><td>' + item.latitude + '</td><td>' + item.longitude + '</td><td><a href="' + fileName + '" target="_blank"><img src="' + fileName + '" height="50px" /></a></td><td class="text-center"><button onclick="javascript:EditLoc(' + item.locationId + ', ' + item.projectId + ');" type="button" class="btn btn-success waves-effect waves-light"><i class="mdi mdi-lead-pencil"></i></button> <button onclick="javascript:Delete(' + item.locationId + ', ' + item.projectId + ', \'CcModPrjLocationDetail\'); GetProjLocationsData();" type="button" class="btn btn-danger waves-effect waves-light"><i class="mdi mdi-delete"></i></button> <input id="hdLocationId" value="' + locationId + '" /></td></tr>';
                                rows += '<tr><td>' + item.districtName + ' <input id="hdDistrictGeoCode" type="hidden" value="' + item.districtGeoCode + '" /></td><td>' + item.upazilaName + ' <input id="hdUpazilaGeoCode" type="hidden" value="' + item.upazilaGeoCode + '" /></td><td>' + item.unionName + ' <input id="hdUnionGeoCode" type="hidden" value="' + item.unionGeoCode + '" /></td><td>' + latitude + '</td><td>' + longitude + '</td><td>' + imgs + '</td><td><a href="' + map_file + '" target="_blank">' + map_file_name + '</a></td><td class="text-center"><button onclick="javascript:DeleteLocation(this, ' + item.locationId + ', ' + item.projectId + ', \'CcModPrjLocationDetail\');" type="button" class="btn btn-danger waves-effect waves-light"><i class="mdi mdi-delete"></i></button> <input id="hdLocationId" type="hidden" value="' + item.locationId + '" /></td></tr>';
                            });
                        }

                        jQuery("#tbodyProjectLocation").html(rows);
                    } else {
                        jQuery("#tbodyProjectLocation").html('<tr><td colspan="8" class="text-center text-red"><div class="alert alert-warning" role="alert"> Sorry, no data found </div></td></tr>');
                    }
                }, error: function (jqXHR, exception) {
                    var errorMsg = AjaxErrorHandle(jqXHR, exception);
                    jQuery("#tbodyProjectLocation").html('<tr><td colspan="8" class="text-center text-red"><div class="alert alert-danger" role="alert">' + errorMsg + '</div></td></tr>');
                    Notification('error', 'Error Occured', errorMsg);
                }
            });
        }

    function GetAdminData(code, type) {
            var lang = '@language';
            var url = '@Url.Action("gab", "common")';

            jQuery.ajax({
                type: "GET",
                url: url,
                data: { code: code, type: type },
                dataType: "json",
                success: function (data, status, jqXHR) {
                    //console.log(data);

                    if (lang == '1') {
                        jQuery("#UpazilaGeoCode").html('<option value="">বাছাই করুন...</option>');
                        jQuery("#UnionGeoCode").html('<option value="">বাছাই করুন...</option>');
                    } else {
                        jQuery("#UpazilaGeoCode").html('<option value="">Choose...</option>');
                        jQuery("#UnionGeoCode").html('<option value="">Choose...</option>');
                    }

                    if (type == 'upz') {
                        //jQuery("#UpazilaGeoCode").html('<option value="">Choose...</option>');

                        if (lang == '1') {
                            jQuery.each(data, function (i, item) {
                                var content = '<option value="' + item.code + '">' + item.ab_name_bn + '</option>';
                                jQuery("#UpazilaGeoCode").append(content);
                            });
                        } else {
                            jQuery.each(data, function (i, item) {
                                var content = '<option value="' + item.code + '">' + item.ab_name + '</option>';
                                jQuery("#UpazilaGeoCode").append(content);
                            });
                        }
                    } else if (type == 'uni') {
                        //jQuery("#UnionGeoCode").html('<option value="">Choose...</option>');

                        if (lang == '1') {
                            jQuery.each(data, function (i, item) {
                                var content = '<option value="' + item.code + '">' + item.ab_name_bn + '</option>';
                                jQuery("#UnionGeoCode").append(content);
                            });
                        } else {
                            jQuery.each(data, function (i, item) {
                                var content = '<option value="' + item.code + '">' + item.ab_name + '</option>';
                                jQuery("#UnionGeoCode").append(content);
                            });
                        }
                    }
                }, error: function (jqXHR, exception) {
                    var errorMsg = AjaxErrorHandle(jqXHR, exception);
                    Notification('error', 'Error Occured', errorMsg);
                }
            });
        }

    function GetAdminData(code, type, val) {
        var lang = '@language';
        var url = '@Url.Action("gab", "common")';

        jQuery.ajax({
            type: "GET",
            url: url,
            data: { code: code, type: type },
            dataType: "json",
            success: function (data, status, jqXHR) {
                var content = '';

                if (type == 'upz') {
                    if (lang == '1') {
                        jQuery("#UpazilaGeoCode").html('<option value="">বাছাই করুন...</option>');

                        jQuery.each(data, function (i, item) {
                            if (val == item.code)
                                content = '<option value="' + item.code + '" selected>' + item.ab_name_bn + '</option>';
                            else
                                content = '<option value="' + item.code + '">' + item.ab_name_bn + '</option>';

                            jQuery("#UpazilaGeoCode").append(content);
                        });
                    } else {
                        jQuery("#UpazilaGeoCode").html('<option value="">Choose...</option>');

                        jQuery.each(data, function (i, item) {
                            if (val == item.code)
                                content = '<option value="' + item.code + '" selected>' + item.ab_name + '</option>';
                            else
                                content = '<option value="' + item.code + '">' + item.ab_name + '</option>';

                            jQuery("#UpazilaGeoCode").append(content);
                        });

                        //jQuery("#UpazilaGeoCode").val(val);
                    }
                } else if (type == 'uni') {
                    if (lang == '1') {
                        jQuery("#UnionGeoCode").html('<option value="">বাছাই করুন...</option>');

                        jQuery.each(data, function (i, item) {
                            if (val == item.code)
                                content = '<option value="' + item.code + '" selected>' + item.ab_name_bn + '</option>';
                            else
                                content = '<option value="' + item.code + '">' + item.ab_name_bn + '</option>';

                            jQuery("#UnionGeoCode").append(content);
                        });
                    } else {
                        jQuery("#UnionGeoCode").html('<option value="">Choose...</option>');

                        jQuery.each(data, function (i, item) {
                            if (val == item.code)
                                content = '<option value="' + item.code + '" selected>' + item.ab_name + '</option>';
                            else
                                content = '<option value="' + item.code + '">' + item.ab_name + '</option>';

                            jQuery("#UnionGeoCode").append(content);
                        });
                    }

                    //jQuery("#UnionGeoCode").val(val);
                }
            }, error: function (jqXHR, exception) {
                var errorMsg = AjaxErrorHandle(jqXHR, exception);
                Notification('error', 'Error Occured', errorMsg);
            }
        });
    }

    function EditLoc(id, projectId) {
            var url = '@Url.Action("gsl", "form")';
            jQuery.ajax({
                type: "GET",
                url: url,
                data: { id: id, projectId: projectId },
                dataType: "json",
                success: function (data, status, jqXHR) {
                    if (data.locationId != '') {
                        //console.log(data);

                        SetHiddenValue('LocationId', data.locationId);
                        jQuery("#DistrictGeoCode option[value=" + data.districtGeoCode + "]").prop('selected', true);
                        GetAdminData(data.districtGeoCode, 'upz', data.upazilaGeoCode);
                        GetAdminData(data.upazilaGeoCode, 'uni', data.unionGeoCode);
                        //jQuery("#DistrictGeoCode").val(data.districtGeoCode).attr('selected', 'selected');
                        SetTextValue('Latitude', data.latitude);
                        SetTextValue('Longitude', data.longitude);
                    }
                }, error: function (jqXHR, exception) {
                    var errorMsg = AjaxErrorHandle(jqXHR, exception);
                    Notification('error', 'Error Occured', errorMsg);
                }
            });
        }

    function DeleteNewLocation(index) {
        Swal.fire({
            title: "Are you sure?",
            text: "You won't be able to revert this",
            type: "warning",
            allowEscapeKey: false,
            allowOutsideClick: false,
            showCancelButton: !0,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Sure"
        }).then(function (t) {
            if (t.value == true) {
                var row = index.parentNode.parentNode;
                row.parentNode.removeChild(row);
            }
        });
    }

    function DeleteLocation(index, id, projectId, modelName) {
        var row = index.parentNode.parentNode;

        Swal.fire({
            title: "Are you sure?",
            text: "You won't be able to revert this",
            type: "warning",
            allowEscapeKey: false,
            allowOutsideClick: false,
            showCancelButton: !0,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Sure"
        }).then(function (t) {
            if (t.value == true) {
                var url = '@Url.Action("cdm", "form")';
                jQuery.ajax({
                    type: "POST",
                    url: url,
                    data: { id: id, projectId: projectId, modelName: modelName },
                    dataType: "json",
                    success: function (data, status, jqXHR) {
                        if (data.status == 'success') {
                            row.parentNode.removeChild(row);
                            Notification('success', 'Success', data.message);
                            Swal.fire("Success", data.message, "success");
                        } else {
                            Notification('error', 'Deletion Error', data.message);
                            Swal.fire("Deletion Error", data.message, "error");
                        }
                    }, error: function (jqXHR, exception) {
                        var errorMsg = AjaxErrorHandle(jqXHR, exception);
                        Notification('error', 'Error Occured', errorMsg);
                    }
                });
            }
        });
    }

    function ValidateFileUpload() {
        var lfuData = document.getElementById('MapFile');
        var FileUploadPath = lfuData.value;

        if (FileUploadPath == '') {
            Notification('info', 'Select Project Location Map', 'Please select project location\'s KML formatted file.');
            Swal.fire('Select Project Location Map', 'Please select project location\'s KML formatted file.', 'info');
        } else {
            var kml_file = lfuData.files[0];
            var FileName = lfuData.files[0].name;
            var Extension = FileName.replace(/^.*\./, '');

            if (Extension == "kml" || Extension == "KML") {
                if (lfuData.files && lfuData.files[0]) {
                    var reader = new FileReader();
                    reader.readAsDataURL(lfuData.files[0]);
                    reader.onload = function (e) {
                        var file_size = kml_file.size/1024/1024;
                        file_size = file_size.toFixed(2);

                        if (file_size > 1) {
                            Notification('warning', 'Exceeding File Size', 'Maximum file size is 1 MB. You file size is: ' + file_size + ' MB.');
                            Swal.fire('Exceeding File Size', 'Maximum file size is 1 MB. You file size is: ' + file_size + ' MB.', 'warning');
                            return;
                        }

                        //var image = new Image();
                        //image.src = e.target.result;
                        //image.onload = function () {
                        //    var height = this.height;
                        //    var width = this.width;
                        //    if (height > 85) {
                        //        Notification('warning', 'Exceeding Image Height', 'Height must not exceed 80px.');
                        //        Swal.fire('Exceeding Image Height', 'Height must not exceed 80px.', 'warning');
                        //        return false;
                        //    }
                        //    if (width > 315) {
                        //        Notification('warning', 'Exceeding Image Width', 'Width must not exceed 300px');
                        //        Swal.fire('Exceeding Image Width', 'Width must not exceed 300px', 'warning');
                        //        return false;
                        //    }
                        //};
                        //$('#PrevSignatureFile').attr('src', e.target.result);
                        //$('#PrevSignatureFile').show();

                        $('#SelectedMapFile').val(e.target.result);
                        $('#SelectedMapFile').attr('title', FileName);
                    }
                }
                else {
                    $('#SelectedMapFile').val('');
                    $('#SelectedMapFile').attr('title', '');
                }
            }
            else {
                Notification('warning', 'Invalid File Format', 'File only allows file type of KML.');
                Swal.fire('Invalid File Format', 'File only allows file type of KML.', 'warning');
            }
        }
    }

    function toLower(str) {
        var result = '';
        for (var i = 0, len = str.length; i < len; i++) {
            var charAtLocation = str.charCodeAt(i);
            if (charAtLocation > 64 && charAtLocation < 91) //ASCII for upper-case
                result += String.fromCharCode(charAtLocation + 32);
            else
                result += str[i];
        }
        return result;
    }

    //un ordered list to keep attachments thumbnails
    var ul = document.createElement('ul');
    ul.className = ("thumb-Images");
    ul.id = "imgList";

    function init() {
        //add javascript handlers for the file upload event
        document.querySelector('#files').addEventListener('change', handleFileSelect, false);
    }

    //the handler for file upload event
    function handleFileSelect(e) {
        //to make sure the user select file/files
        if (!e.target.files) return;

        //To obtaine a File reference
        var files = e.target.files;

        // Loop through the FileList and then to render image files as thumbnails.
        for (var i = 0, f; f = files[i]; i++) {

            //instantiate a FileReader object to read its contents into memory
            var fileReader = new FileReader();

            // Closure to capture the file information and apply validation.
            fileReader.onload = (function (readerEvt) {
                return function (e) {
                    //Apply the validation rules for attachments upload
                    ApplyFileValidationRules(e, readerEvt)

                    //Render attachments thumbnails.
                    RenderThumbnail(e, readerEvt);

                    //Fill the array of attachment
                    FillAttachmentArray(e, readerEvt)
                };
            })(f);

            // Read in the image file as a data URL.
            // readAsDataURL: The result property will contain the file/blob's data encoded as a data URL.
            // More info about Data URI scheme https://en.wikipedia.org/wiki/Data_URI_scheme
            fileReader.readAsDataURL(f);
        }

        document.getElementById('files').addEventListener('change', handleFileSelect, false);
    }

    //To remove attachment once user click on x button
    jQuery(function ($) {
        $('div').on('click', '.img-wrap .close', function () {
            var id = $(this).closest('.img-wrap').find('img').data('id');

            //to remove the deleted item from array
            var elementPos = AttachmentArray.map(function (x) { return x.FileName; }).indexOf(id);
            if (elementPos !== -1) {
                AttachmentArray.splice(elementPos, 1);
            }

            //to remove image tag
            $(this).parent().find('img').not().remove();

            //to remove div tag that contain the image
            $(this).parent().find('div').not().remove();

            //to remove div tag that contain caption name
            $(this).parent().parent().find('div').not().remove();

            //to remove li tag
            var lis = document.querySelectorAll('#imgList li');
            for (var i = 0; li = lis[i]; i++) {
                if (li.innerHTML == "") {
                    li.parentNode.removeChild(li);
                }
            }
        });
    });

    //Apply the validation rules for attachments upload
    function ApplyFileValidationRules(e, readerEvt) {
        var msg = '';
        //To check file type according to upload conditions
        if (CheckFileType(readerEvt.type) == false) {
            msg = "The file (" + readerEvt.name + ") does not match the upload conditions, You can only upload jpg/png/gif/bmp/pdf files";
            Notification('warning', 'Invalid File Format', msg);
            e.preventDefault();
            return false;
        }

        //To check file Size according to upload conditions
        if (CheckFileSize(readerEvt.size) == false) {
            msg = "The file (" + readerEvt.name + ") does not match the upload conditions, The maximum file size for uploads should not exceed 800 KB";
            Notification('warning', 'Maximum Length Exceeded', msg);
            e.preventDefault();
            return false;
        }

        //To check files count according to upload conditions
        if (CheckFilesCount(AttachmentArray) == false) {
            if (!filesCounterAlertStatus) {
                filesCounterAlertStatus = true;
                msg = "You have added more than 5 files. According to upload conditions you can upload 5 files maximum";
                Notification('warning', 'Maximum File Selected', msg);
            }
            e.preventDefault();
            return false;
        }
    }

    //To check file type according to upload conditions
    function CheckFileType(fileType) {
        if (fileType == "image/jpeg" ||
            fileType == "image/png" ||
            fileType == "image/gif" ||
            fileType == "image/bmp" ||
            fileType == "application/pdf") {
            return true;
        } else {
            return false;
        }

        return true;
    }

    //To check file Size according to upload conditions
    function CheckFileSize(fileSize) {
        //900000 = 900kb
        if (fileSize < 900000) {
            return true;
        } else {
            return false;
        }

        return true;
    }

    //To check files count according to upload conditions
    function CheckFilesCount(AttachmentArray) {
        var len = 0;
        for (var i = 0; i < AttachmentArray.length; i++) {
            if (AttachmentArray[i] !== undefined) {
                len++;
            }
        }

        //To check the length does not exceed 5 files maximum
        if (len > 5) {
            return false;
        } else {
            return true;
        }
    }

    //Render attachments thumbnails.
    function RenderThumbnail(e, readerEvt) {
        var li = document.createElement('li');
        ul.appendChild(li);
        li.innerHTML = ['<div class="img-wrap"> <span class="close">&times;</span>' +
            '<img class="thumb" src="', e.target.result, '" title="', escape(readerEvt.name), '" data-id="',
        readerEvt.name, '"/>' + '</div>'].join('');

        //var div = document.createElement('div');
        //div.className = "FileNameCaptionStyle";
        //li.appendChild(div);
        //div.innerHTML = [readerEvt.name].join('');
        document.getElementById('Filelist').insertBefore(ul, null);
    }

    //Fill the array of attachment
    function FillAttachmentArray(e, readerEvt) {
        AttachmentArray[arrCounter] = {
            AttachmentType: 1,
            ObjectType: 1,
            FileName: readerEvt.name,
            FileDescription: "Attachment",
            NoteText: "",
            MimeType: readerEvt.type,
            FullContent: e.target.result,
            Content: e.target.result.split("base64,")[1],
            FileSizeInBytes: readerEvt.size,
        };

        arrCounter = arrCounter + 1;
    }
</script>