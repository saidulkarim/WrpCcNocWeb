@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor

@{
    var language = HttpContextAccessor.HttpContext.Request.Cookies["FormLanguage"].ToString();
}

<div id="gen-info-form">
    <div class="form-group">
        <label for="ProjectName">
            @{if (language == "1")
                { <span>১. প্রকল্প শিরোনাম</span>}
                else
                {<span>1. Project Name</span>}
            } 
            <span class="text-danger bold">*</span>
        </label>
        <input type="text" id="ProjectName" name="ProjectName" class="form-control" data-toggle="tooltip"
               data-placement="left" title="" data-original-title="Press Control and b (Ctrl + b) key from keyboard to change language." />
    </div>

    <div class="form-group">
        <label for="BackgroundAndRationale">
            @{if (language == "1")
                { <span>২. প্রকল্পের পূর্ব ইতিহাস ও যৌক্তিকতা</span>}
                else
                {<span>2. Project Background and Rationale</span>}
            } 
            <span class="text-danger bold">*</span>
        </label>
        <textarea id="BackgroundAndRationale" name="BackgroundAndRationale" class="form-control" rows="2"
                  data-toggle="tooltip" data-placement="left" title="" data-original-title="Press Control and b (Ctrl + b) key from keyboard to change language."></textarea>
    </div>

    <div class="form-group">
        <label for="ProjectTarget">
            @{if (language == "1")
                { <span>৩. প্রকল্পের লক্ষ্য</span>}
                else
                {<span>3. Project Target</span>}
            } 
            <span class="text-danger bold">*</span>
        </label>
        <textarea id="ProjectTarget" name="ProjectTarget" class="form-control" rows="2"
                  data-toggle="tooltip" data-placement="left" title="" data-original-title="Press Control and b (Ctrl + b) key from keyboard to change language."></textarea>
    </div>

    <div class="form-group">
        <label for="ProjectObjective">
            @{if (language == "1")
                { <span>৪. প্রকল্পের উদ্দেশ্য</span>}
                else
                {<span>4. Project Objective</span>}
            } 
            <span class="text-danger bold">*</span>
        </label>
        <textarea id="ProjectObjective" name="ProjectObjective" class="form-control" rows="2"
                  data-toggle="tooltip" data-placement="left" title="" data-original-title="Press Control and b (Ctrl + b) key from keyboard to change language."></textarea>
    </div>

	<div class="form-group">
        <label for="ProjectActivity">
            @if (language == "1")
			{ <span>৫. প্রকল্পের অবস্থান</span> }
			else
			{ <span>5. Project Location</span> } <span class="text-danger bold">*</span>            
        </label>
		<br />
        <button id="btnShowProjectLocations" type="button" data-toggle="modal" data-target="#projectLocationModal" 
				class="btn btn-info waves-effect waves-light">
            <span class="btn-label"><i class="mdi mdi-map-plus"></i></span>
            @if (language == "1")
			{ <span>প্রকল্পের অবস্থান</span> }
			else
			{ <span>Project Location</span> }
            <span class="myspinner spinner-border spinner-border-sm mr-1 d-none"></span>					
        </button>
		
		<span id="spnTotalLocations" class="badge badge-info"></span>
		
		<!-- Modal -->
		<div class="modal fade" id="projectLocationModal" tabindex="-1" role="dialog" 
			 aria-labelledby="projectLocationModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="projectLocationModalLabel">
							@if (language == "1")
							{ <span>প্রকল্পের অবস্থান</span> }
							else
							{ <span>Project Location</span> }
						</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						@{ Html.RenderPartial("form/_3Location"); }
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>				
					</div>
				</div>
			</div>
		</div>
    </div>
	
	<div class="form-group">
        <label for="ProjectActivity">
            @{if (language == "1")
                { <span>৬. থানা বেজ ম্যাপে জিও কোডসহ প্রকল্পের সীমানা</span>}
                else
                {<span>6. Project Boundary with Geo Code at Thana Base Map</span>}
            }
        </label>
        <br />
        <button id="btnShowProjectBoundary" type="button" data-toggle="modal" data-target="#projectBoundaryModal" 
				class="btn btn-success waves-effect waves-light">
            <span class="btn-label"><i class="mdi mdi-map-marker-path"></i></span>
				@if (language == "1")
				{ <span>প্রকল্পের সীমানা</span> }
				else
				{ <span>Project Boundary</span> }
            <span class="myspinner spinner-border spinner-border-sm mr-1 d-none"></span>
        </button>
    </div>	
	
    <div class="form-group">
        <label for="ProjectActivity">
            @{if (language == "1")
                { <span>৭. প্রকল্পের ভৌত কাজের বিবরণ/ অবকাঠামো সমূহ</span>}
                else
                {<span>7. Project Activities/ Components</span>}
            }
        </label>
        <textarea id="ProjectActivity" name="ProjectActivity" class="form-control" rows="2"
                  data-toggle="tooltip" data-placement="left" title="" data-original-title="Press Control and b (Ctrl + b) key from keyboard to change language."></textarea>
    </div>

    <div class="divProjectPeriod">
        <fieldset>
            <legend>
                <label for="ProjectPeriod" class="bold">
                    @{if (language == "1")
                        { <span>৮. প্রকল্প সময়কাল</span>}
                        else
                        {<span>8. Project Period</span>}
                    } 
                    <span class="text-danger bold">*</span>
                </label>
            </legend>

            <div class="row">
                <div class="form-group col-md-6">
                    <label for="ProjectStartDate">
                        @{if (language == "1")
                            { <span>প্রাম্ভিক কাল</span>}
                            else
                            {<span>Starting Time</span>}
                        }
                    </label>
                    <input type="text" id="ProjectStartDate" name="ProjectStartDate" class="form-control datepicker" />
                </div>

                <div class="form-group col-md-6">
                    <label for="ProjectCompletionDate">
                        @{if (language == "1")
                            { <span>সমাপ্তি কাল</span>}
                            else
                            {<span>Completion Time</span>}
                        }
                    </label>
                    <input type="text" id="ProjectCompletionDate" name="ProjectCompletionDate" class="form-control datepicker" />
                </div>
            </div>
        </fieldset>
    </div>

    <div class="form-group col-md-6" style="padding-left: 0 !important;">
        <label for="ProjectEstimatedCost">
            @{
                if (language == "1")
                { <span>৯. প্রকল্পের প্রাক্কলিত মোট ব্যয় (লক্ষ টাকায়)</span>}
                else
                {<span>9. Estimated Project Cost (In Lakh Taka)</span>}
            } 
            <span class="text-danger bold">*</span>
        </label>

        <input type="number" maxlength="10" min="0" id="ProjectEstimatedCost" name="ProjectEstimatedCost" class="form-control text-right" />
    </div>

    <div class="form-group">
        <label for="ProjectOutcome">
            @{if (language == "1")
                { <span>১০. প্রকল্পের ফলাফল</span>}
                else
                {<span>10. Project Outcome</span>}
            }
        </label>
        <textarea id="ProjectOutcome" name="ProjectOutcome" class="form-control" rows="2"
                  data-toggle="tooltip" data-placement="left" title="" data-original-title="Press Control and b (Ctrl + b) key from keyboard to change language."></textarea>
    </div>

    <div class="form-group">
        <label for="ProjectOutput">
            @{if (language == "1")
                { <span>১১. প্রকল্পের আউটপুট</span>}
                else
                {<span>11. Project Output</span>}
            }
        </label>
        <textarea id="ProjectOutput" name="ProjectOutput" class="form-control" rows="2"
                  data-toggle="tooltip" data-placement="left" title="" data-original-title="Press Control and b (Ctrl + b) key from keyboard to change language."></textarea>
    </div>

    <div class="form-group mb-0">
        <button id="btnSaveGeneral" type="button" class="btn btn-info waves-effect waves-light">
            <span class="btn-label"><i class="mdi mdi-content-save"></i></span>
            @if (language == "1")
            {
                <span>সংরক্ষণ করুন</span>
            }
            else
            {
                <span>Save</span>
            }
            <span class="myspinner spinner-border spinner-border-sm mr-1 d-none"></span>
        </button>

        <button id="btnClearGeneral" type="button" class="btn btn-secondary waves-effect waves-light">
            <span class="btn-label"><i class="mdi mdi-close-outline"></i></span>
            @if (language == "1")
            {
                <span>পরিষ্কার করুন</span>
            }
            else
            {
                <span>Clear</span>
            }
        </button>
    </div>
</div>

<script type="text/javascript">
    jQuery(document).ready(function () {
        jQuery("#btnSaveGeneral").click(function () {
            var ProjectName = GetTextValue('ProjectName');
            var BackgroundAndRationale = GetTextValue('BackgroundAndRationale');
            var ProjectTarget = GetTextValue('ProjectTarget');
            var ProjectObjective = GetTextValue('ProjectObjective');
            var ProjectStartDate = GetTextValue('ProjectStartDate');
            var ProjectCompletionDate = GetTextValue('ProjectCompletionDate');
            var ProjectEstimatedCost = GetTextValue('ProjectEstimatedCost') == '' ? '0' : GetTextValue('ProjectEstimatedCost');
            var ProjectOutcome = GetTextValue('ProjectOutcome');
            var ProjectOutput = GetTextValue('ProjectOutput');

            if (ProjectName == '') {
                Notification('warning', 'Required Field', 'Project name can not be left empty.');
                Swal.fire('Required Field', 'Project name can not be left empty.', 'warning');
                jQuery('#ProjectName').focus();
                return;
            }

            if (BackgroundAndRationale == '') {
                Notification('warning', 'Required Field', 'Project background and rationale can not be left empty.');
                Swal.fire('Required Field', 'Project background and rationale can not be left empty.', 'warning');
                jQuery('#BackgroundAndRationale').focus();
                return;
            }

            if (ProjectTarget == '') {
                Notification('warning', 'Required Field', 'Project target can not be left empty.');
                Swal.fire('Required Field', 'Project target can not be left empty.', 'warning');
                jQuery('#ProjectTarget').focus();
                return;
            }

            if (ProjectObjective == '') {
                Notification('warning', 'Required Field', 'Project objective can not be left empty.');
                Swal.fire('Required Field', 'Project objective can not be left empty.', 'warning');
                jQuery('#ProjectObjective').focus();
                return;
            }

            if (ProjectStartDate == '') {
                Notification('warning', 'Required Field', 'Please select a project start date and can not be left empty.');
                Swal.fire('Required Field', 'Please select a project start date and can not be left empty.', 'warning');
                jQuery('#ProjectStartDate').focus();
                return;
            }

            if (ProjectCompletionDate == '') {
                Notification('warning', 'Required Field', 'Please select a project completion date and can not be left empty.');
                Swal.fire('Required Field', 'Please select a project completion date and can not be left empty.', 'warning');
                jQuery('#ProjectCompletionDate').focus();
                return;
            }

            if (ProjectEstimatedCost == '') {
                Notification('warning', 'Required Field', 'Please enter project estimated cost amount.');
                Swal.fire('Required Field', 'Please enter project estimated cost amount.', 'warning');
                jQuery('#ProjectEstimatedCost').focus();
                return;
            }

            if (!IsNumeric(ProjectEstimatedCost)) {
                Notification('warning', 'Required Field', 'Please enter valid project estimated cost amount.');
                Swal.fire('Required Field', 'Please enter valid project estimated cost amount.', 'warning');
                jQuery('#ProjectEstimatedCost').focus();
                return;
            }

            if (parseFloat(ProjectEstimatedCost) == 0 || parseFloat(ProjectEstimatedCost) < 0) {
                Notification('warning', 'Required Field', 'Project estimated cost amount can not be equal to zero (0) or can not be negative.');
                Swal.fire('Required Field', 'Project estimated cost amount can not be equal to zero (0) or can not be negative.', 'warning');
                jQuery('#ProjectEstimatedCost').focus();
                return;
            }

            GeneralInfoSave();
        });

        jQuery("#btnClearGeneral").click(function () {
                Swal.fire({
                    title: "Are you sure?",
                    text: "All data will be cleared from General Information panel!",
                    type: "warning",
                    allowEscapeKey: false,
                    allowOutsideClick: false,
                    showCancelButton: !0,
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33",
                    confirmButtonText: "Sure"
                }).then(function (t) {
                    if (t.value == true) {
                        $('#gen-info-form').trigger("reset");
                    }
                });
            });
    });

    function GeneralInfoSave() {
        var ProjectName = GetTextValue('ProjectName');
        var BackgroundAndRationale = GetTextValue('BackgroundAndRationale');
        var ProjectTarget = GetTextValue('ProjectTarget');
        var ProjectObjective = GetTextValue('ProjectObjective');
        var ProjectActivity = GetTextValue('ProjectActivity');
        var ProjectStartDate = GetTextValue('ProjectStartDate');
        var ProjectCompletionDate = GetTextValue('ProjectCompletionDate');
        var ProjectEstimatedCost = GetTextValue('ProjectEstimatedCost') == '' ? '0' : GetTextValue('ProjectEstimatedCost');
        var ProjectOutcome = GetTextValue('ProjectOutcome');
        var ProjectOutput = GetTextValue('ProjectOutput');

        var pcd = {
            "ProjectId": jQuery('#ProjectId').val(),
            "UserId": 0,
            "AppSubmissionId": jQuery('#AppSubmissionId').val(),
            "ApplicationStateId": jQuery('#ApplicationStateId').val(),
            "ApprovalStatusId": jQuery('#ApprovalStatusId').val(),
            "ProjectTypeId": jQuery('#ProjectTypeId').val(),
            "ProjectName": ProjectName,
            "BackgroundAndRationale": BackgroundAndRationale,
            "ProjectTarget": ProjectTarget,
            "ProjectObjective": ProjectObjective,
            "ProjectActivity": ProjectActivity,
            "ProjectStartDate": ProjectStartDate,
            "ProjectCompletionDate": ProjectCompletionDate,
            "ProjectEstimatedCost": ProjectEstimatedCost,
            "ProjectOutcome": ProjectOutcome,
            "ProjectOutput": ProjectOutput
        };

        //console.log(pcd);

        //#region project location script
        var rowCount = $('#tbodyProjectLocation tr').length;
        var LocationArray = [], ImageFiles =[];

        var table = $("#tbodyProjectLocation");
        table.find('tr').each(function (i) {
            var $tds = $(this).find('td');

            var LocationId = $tds.eq(7).find('input[type=hidden]').val();
            LocationId = (LocationId == '') ? 0 : LocationId;
            var DistrictGeoCode = $tds.eq(0).find('input[type=hidden]').val();
            var UpazilaGeoCode = $tds.eq(1).find('input[type=hidden]').val();
            var UnionGeoCode = $tds.eq(2).find('input[type=hidden]').val();
            var Latitude = $tds.eq(3).text();
            var Longitude = $tds.eq(4).text();
            var ImageFile = $tds.eq(5).find('input[type=hidden]').val();
            var MapFile = $tds.eq(6).find('input[type=hidden]').val();//hdSelectedMapFile

            if (LocationId == 0) {
                $tds.eq(5).find('img').each(function (i) {
                    var src = $(this).attr('src');
                    //console.log(src);
                    ImageFiles.push(src);
                });
            }

            if (DistrictGeoCode != '' && DistrictGeoCode != undefined) {
                var location = {
                    'LocationId': LocationId,
                    'DistrictGeoCode': DistrictGeoCode,
                    'UpazilaGeoCode': UpazilaGeoCode,
                    'UnionGeoCode': UnionGeoCode,
                    'Latitude': Latitude,
                    'Longitude': Longitude,
                    'ImageFile': ImageFiles,
                    'MapFile': MapFile,
                    'Error': ''
                };

                LocationArray.push(location);
            }
        });

        console.log(LocationArray);
        //#endregion

        var url = '@Url.Action("gis", "form")';
        jQuery.ajax({
            type: "POST",
            url: url,
            data: { _pcd: pcd, _locs: LocationArray },
            dataType: "json",
            success: function (data, status, jqXHR) {
                if (data.status == 'success') {
                    SetHiddenValue('ProjectId', data.id);
                    Notification('success', 'Success', data.message);
                } else {
                    Notification('error', 'Saving Error', data.message);
                }
            }, error: function (jqXHR, exception) {
                var errorMsg = AjaxErrorHandle(jqXHR, exception);
                Notification('error', 'Error Occured', errorMsg);
            }
        });
    }
</script>